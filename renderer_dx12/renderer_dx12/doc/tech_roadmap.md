# DirectX12 渲染架构技术路线图

## 路线图规划原则 （作为辅助编程的AI，你不应该修改这一部分）

这个项目的目标是完成一个灵活的，具有高可用性的渲染架构，可以方便得试验各种新渲染技术，一个工业级的游戏/渲染引擎不是这个项目的目标，进行渲染架构技术路线图时必须要考虑这一点，不要引入过高的复杂度、过多的抽象层等。

## 阶段 1：解耦与基础设施重构（近期）

- **移除单例与全局状态**：将 `DirectX12Device` 改为可显式构造、可并行存在的实例，确保线程安全，同时在单 GPU 场景下也能灵活配置设备。（✅ 已完成）
- **拆分初始化流程**：将设备创建、队列配置、交换链、描述符堆、离屏资源等步骤模块化，构建 RAII 式资源管理与失败回滚机制，并补充详细日志。（✅ 模块化完成，日志系统已完善）
- **统一资源生命周期管理**：引入智能指针或自定义句柄封装，消除手动 `Release`，为后续自动化测试铺路。（✅ DXGI/D3D12 资源已统一管理）
- **统一光照系统重构**：引入 `SceneLight` 和 `LightManager`，消除不同材质的光照数据冗余，为多光源实验奠定基础。（✅ **2025-11-10 已完成**）
- **实时反射渲染技术验证**：实现 `ReflectionScene` 系统，建立完整的反射渲染管线，验证离屏渲染与高级渲染技术的架构设计。（✅ **2025-11-11 已完成**）

## 阶段 2：帧资源与命令调度（中期）

- **构建帧资源环**：为每帧维护独立的命令分配器、命令列表、fence、常量缓冲等，支持并行录制与跨帧资源同步。（✅ 已完成基础框架，`FrameResource` 结构已实现，包含 per-frame command allocator 与 fence value，支持稳定的双缓冲渲染）
- **扩展常量缓冲池管理**：当前常量缓冲由各材质类（`ScreenQuadMaterial`、`PBRMaterial`、`ModelMaterial`）独立管理，建议添加资源池示例，展示跨帧复用模式。（⏳ 待补充示例与最佳实践文档）
- **扩展命令队列池**：提供 direct / compute / copy 队列及其管理接口，允许实验异步 Pass、异步拷贝及任务调度策略。（⏳ Direct 与 Copy 队列已完成，Compute 队列接口预留但未实现，按需扩展）
- **完善同步机制**：抽象 fence 与事件管理，提供可配置的等待策略与调试可视化输出。（✅ `WaitForPreviousFrame` 与 `WaitForGpuIdle` 已稳定运行，调试可视化待增强）

## 阶段 3：渲染目标与资源弹性（中期 - 部分完成）

- **RenderTarget 管理器**：支持按需创建/销毁多尺寸、多格式的离屏纹理，提供 SRV/RTV 句柄分配。（✅ 核心功能已完成，`CreateRenderTarget`、`DestroyRenderTarget`、`RenderTargetDescriptor` 运作良好，`RenderTexture` 类为反射场景提供专用支持，UAV/DSV 接口待扩展）
- **动态重建能力**：实现窗口 Resize、MSAA、HDR 等配置的热更新流程，确保资源可安全回收与重建。（⏳ **高优先级待实现**，当前为架构最大短板）
- **资源热替换**：支持 Shader、管线状态、根签名的快速重载，便于迭代新技术。（⏳ Shader 热重载中优先级，PSO 重建机制待设计）

## 阶段 4：渲染流程编排（远期）

- **RenderGraph / Pass 描述**：设计基于依赖图的 Pass 管理，支持多阶段渲染实验与自动调度 Barrier。（⏳ 待需求验证，建议先通过手动多 Pass 示例评估必要性）
- **材质与几何解耦**：重构 `ScreenQuad` 等基础组件，允许外部注入材质/常量缓冲布局，提升重用性。（✅ **已完成**，`ScreenQuad` 支持材质注入、外部 CBV、自定义顶点/索引缓冲视图）
- **光照系统统一**：为所有材质提供统一的光源接口，消除冗余数据路径。（✅ **已完成**，`SceneLight` + `LightManager` + `UpdateFromLight` 接口已实现）
- **可扩展管线接口**：统一暴露 Pass 参数、资源绑定、调度策略，支持快速接入新渲染算法。（⏳ 待多 Pass 示例完成后规划，当前灵活性已满足单 Pass 实验需求）

## 支撑措施

- **日志与调试工具**：构建统一日志系统，输出资源创建、同步、Barrier 等关键事件。（⏳ 初始化日志已完善（`DxgiResourceManager`、`LogInitializationFailure`），运行期需补充 PIX 标记与性能统计）
- **自动化验证**：添加基本渲染快照或统计检查，确保架构调整后行为可预期。（⏳ 未开始，建议引入简单的帧哈希验证或输出对比）
- **文档维护**：同步更新 `arch_review.md` 与模块说明，记录设计决策、接口约定与实验指引。（✅ 正在持续迭代与完善）

## 优先级总结（按紧迫性排序）

### 高优先级（立即着手）
1. **窗口 Resize 与资源热重建**：OnResize 接口 + 交换链重建逻辑
2. **UAV/DSV 接口补充**：完善 `RenderTargetDescriptor` 能力，支持计算着色器与深度缓冲实验

### 中优先级（近期规划）
3. **多光源场景实战验证**：测试 2-3 光源场景，适配 Shader 多光源数组传递
4. **PIX 标记与性能统计**：提升调试体验，输出帧时间与 GPU 占用
5. **多 Pass 渲染示例**：延迟渲染或后处理管线参考实现
6. **Shader 热重载**：加速实验迭代，支持 HLSL 文件变更自动更新

### 低优先级（按需扩展）
7. **Compute 队列接口**：仅在引入计算着色器实验时实现
8. **光照剔除优化**：Tiled/Clustered Lighting，待多光源性能瓶颈出现后实现
9. **RenderGraph 系统**：待多 Pass 手动编排验证需求后再抽象
10. **自动化渲染验证**：可选的质量保障工具，非核心功能

## 下一季度里程碑建议

- **Q1 目标（2025-11 至 2026-01）**：
  - ✅ 完成统一光照系统重构（SceneLight + LightManager）
  - ✅ 实现实时反射渲染技术验证（ReflectionScene + RenderTexture）
  - ⏳ 完成窗口 Resize 与资源热重建
  - ⏳ 补充 UAV/DSV 接口
  - ⏳ 集成 PIX 标记系统

- **Q2 目标（2026-02 至 2026-04）**：
  - 实现多光源场景实战验证（2-3 光源）
  - 实现延迟渲染示例管线
  - 实现 Shader 热重载功能
  - 添加性能统计工具（帧时间、GPU占用）

- **Q3 目标（2026-05 至 2026-07）**：
  - 根据多光源实验反馈，决定是否引入光照剔除优化
  - 评估 RenderGraph 与 Compute 队列需求
  - 补充后处理 Pass 示例（Bloom、Tone Mapping等）

- **Q4 目标（2026-08 至 2026-10）**：
  - 完善文档与最佳实践指南
  - 添加自动化渲染验证（可选）
  - 发布稳定版实验框架 v1.0
